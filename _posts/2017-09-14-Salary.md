---
layout: chart
title: "Salary"
date: 2017-09-14
share: true
---
<style>

  ul>li:before {
    content: ""
  }

  .xAxis text {
    font-size: 11px;
  }

  .yAxis text {
    font-size: 11px;
  }

  .xAxis .tick line {
    visibility: hidden;
  }

  .capLine line {
    stroke-width: 3px;
    stroke: orange;
  }

  .capLine text {
    stroke: black;
    stroke-width: .3px;
  }

  #freeAgents input {
                margin-top: 2.5px;
  }
  #freeAgents label {
      /* display: inline; */
      margin-bottom: 20px;
  }
  input.inputValue {
    margin-left: 12px;
    width: 85px;
  }
 
  #sliders {
    vertical-align: middle;
    height: 50px;
    position: fixed;
    margin-top: 28px;
  }

  #sliders ul {
    list-style: none;
  }


</style>
<body>
  <svg id="salary"></svg>
  <svg id="freeAgents"></svg>
  <span id="sliders"></span>

</body>

<script>

  // utility functions
  function sum( obj ) {
    var sum = 0;
    for ( var el in obj ) {
      if (obj.hasOwnProperty(el)) sum += parseFloat( obj[el] );
    }
    return sum;
  }

  function translate(x, y) {return "translate(" + x + "," + y + ")";}

  function toStack(keys, data) {
    var salaryStack = d3.stack().keys(keys).order(d3.stackOrderDescending).offset(d3.stackOffsetNone);
    return salaryStack(data.map(d => d.salary));
  }

  function toId(name) {return name.replace(' ', '_');}

  // set-up margins for salary svg

  var margin = {top: 50, right: 50, bottom: 125, left: 100},
    width = 1250 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

  var salarySvg = d3.select("svg#salary")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)

  // set-up the graph container
  var graphContainer = salarySvg.append("g")
                                .attr("transform", translate(margin.left, margin.top))

  // set up axises
  var salaryToY = d3.scaleLinear().range([height, 0]);
  salarySvg.append("g")
           .attr("transform", translate(margin.left, margin.top))
           .attr("class", "yAxis")

  var xAxis = d3.scaleBand().rangeRound([0, width]).padding(0.15).align(0.1);
  salarySvg.append("g")
             .attr("class", "xAxis")
             .attr("transform", translate(margin.left, height + margin.top))


  /* Config variables */
  var duration = 750;
  var axisPadding = 5000000;
  var scale = 0.45;
  let projectedCap = 103000000;
  var optionKeys = ["guaranteed", "player-option", "team-option", "stretched"];
  var optionColors = ['#53802c', '#86af49', '#b5e7a0', '#e3eaa7'];

  var optionsToColors = d3.scaleOrdinal().range(optionColors).domain(optionKeys);

  var teamData;
  var data = {{ site.data.salarydata | jsonify }};
  teamData = data;
  initSalaryAxes(data);
  d3.select(".yAxis").call(d3.axisLeft(salaryToY));
  d3.select(".xAxis").call(d3.axisBottom(xAxis));
  drawSalary(data);
  drawLegend(data);

  function initSalaryAxes(data) {
    salaryToY.domain([0, d3.max(data, d => sum(d.salary)) + axisPadding]); 
    xAxis.domain(data.map(d => d.name)).range([0, width]);
  }

  function drawLegend(data) {
    
    var legendContainer = salarySvg.append("g")
                          .attr("font-family", "sans-serif")
                          .attr("font-size", 10)
                          .attr("text-anchor", "end")
                          .attr("transform", translate(98, margin.left / 2 + 10))

    var legend = legendContainer.selectAll("g")
                   .data(optionKeys.slice().reverse())
                   .enter()
                   .append("g")
                   .attr("transform", (d, i) => translate(0, i * 20))

    legend.append("rect")
          .attr("x", width - 19)
          .attr("width", 19)
          .attr("height", 19)
          .attr("fill", optionsToColors)

    legend.append("text")
          .attr("x", width - 24)
          .attr("y", 9.5)
          .attr("dy", "0.32em")
          .text(d => d)

  }

  function drawSalary(data) {

    salaryStack = toStack(optionKeys, data);

    var salaryGroups = graphContainer.selectAll("g") 
                                  .data(salaryStack)
                                  .enter()
                                  .append("g")
                                  .attr("fill", d => optionsToColors(d.key))
                                  .attr("class", "salaryRect")

    var salaryBars = salaryGroups.selectAll("rect")
                                 .data(d => d)
                                 .enter()
                                 .append("g")
                                 .style("cursor", "pointer")
                                 .on("click", (d, i) => drawChildren(data[i]))
 
    salaryBars.append("rect")
              .attr("y", function(d) { return salaryToY(d[1]); })
              .attr("height", function(d) { return salaryToY(d[0]) - salaryToY(d[1]); })
              .transition().duration(duration)
              .attr("width", xAxis.bandwidth())

    salaryBars.transition().duration(duration)
              .attr("transform", (d, i) => translate(xAxis(data[i].name), 0))

    /* Draw Salary Cap Line */
    
    var capLine = graphContainer.append("g")
                  .attr("class", "capLine")

    capLine.append("line")
           .attr("fill", "orange")
           .attr("x1", 0)
           .attr("y1", d => salaryToY(projectedCap))
           .attr("x2", 0)
           .attr("y2", d => salaryToY(projectedCap))

    capLine.append("text")
           .attr("transform", translate(0, salaryToY(projectedCap + 1750000)))
           .text("Projected Cap: $103m")

    d3.select(".capLine line").transition().duration(duration).attr("x2", width);
    d3.select(".capLine text").transition().duration(duration).attr("transform", translate(width - 145, salaryToY(projectedCap + 1750000)));
  }    

  function drawChildren(team) {

    var players = team.players;
    
    var newWidth = width * scale;
    salarySvg.attr("width", newWidth + margin.left + margin.right);

    /* reset axes */
    var maxSalary = d3.max(players, d => d.salary);
    salaryToY.domain([0, maxSalary + axisPadding]);

    d3.select(".yAxis").transition().duration(duration).call(d3.axisLeft(salaryToY));

    xAxis.domain(players.map(d => d.name)).range([0, newWidth]);
    d3.select(".xAxis").transition().duration(duration).call(d3.axisBottom(xAxis))

    d3.selectAll(".xAxis text").transition().duration(duration).attr("y", 0)
                               .attr("x", 9)
                               .attr("dy", ".35em")
                               .attr("transform", "rotate(90)")
                               .style("text-anchor", "start")

    var exitBars = graphContainer.selectAll(".salaryRect").remove();
    var exitLine = graphContainer.select(".capLine").remove();

    var enterBars = graphContainer.selectAll("rect")
                  .data(players)
                  .enter()
                  .append("rect")
                  .attr("class", "playerRect")
                  .attr("width", xAxis.bandwidth())
                  .attr("y", d => salaryToY(d.salary))
                  .attr("height", d => (height - salaryToY(d.salary)))
                  .attr("fill", d => optionsToColors(d.option))

    enterBars.transition().duration(duration)
                  .attr("transform", d => translate(xAxis(d.name), 0))

    // TODO: style this better
    graphContainer.append("text")
                  .attr("transform", translate(10, 25))
                  .style("cursor", "pointer")
                  .text("<-- Back to Team Salaries")
                  .on("click", function() {
                    graphContainer.selectAll(".playerRect").remove();
                    d3.select("#freeAgents").selectAll(".teamSalaryBar").remove();
                    d3.select("#sliders").select("ul").remove()
                    d3.select("#freeAgents").select('.yAxis').remove();
                    d3.select(this).remove();
                    resetSalary();
                    drawSalary(teamData);
                  })

      drawFreeAgents(team);
    }    


    function resetSalary() {
      salarySvg.attr("width", width + margin.left + margin.right);
      initSalaryAxes(teamData);
      d3.select(".yAxis").transition().duration(duration).call(d3.axisLeft(salaryToY));
      d3.select(".xAxis").transition().duration(duration).call(d3.axisBottom(xAxis));
    }

  function drawFreeAgents(team) {
    var origWidth = window.screen.width;
    var leftoverWidth = 140;

    var faSvg = d3.select("#freeAgents").attr("width", leftoverWidth).attr("height", height + margin.top + margin.bottom);

    var salaries = team.salary;

    var faSalaries = team.freeAgents.map(d => d.salary);
    salaries['free-agent'] = faSalaries.reduce((a, b) => a +b );

    var newKeys = optionKeys.slice();
    newKeys.push('free-agent');

    var faColors = optionColors.slice();
    faColors.push("#D3D3D3");
    var faOptionToColor = d3.scaleOrdinal().domain(newKeys).range(faColors);

    var salaryStack = d3.stack().keys(newKeys).order(d3.stackOrderNone).offset(d3.stackOffsetNone);
    var salarySeries = salaryStack([salaries]);

    var freeAgentContainer = faSvg.append("g")
                                  .attr("transform", translate(80, margin.top))
                                  .attr("class", "teamSalaryBar")

    var faSalaryToY = d3.scaleLinear().range([height, 0]).domain([0, 175000000]);

    faSvg.append("g")
         .attr("class", "yAxis")
         .attr("transform", translate(70, margin.top))
         .call(d3.axisLeft(faSalaryToY));

    freeAgentContainer.append("g")
                      .selectAll("g")
                      .data(salarySeries)
                      .enter()
                      .append("rect")
                      .attr("fill", d => faOptionToColor(d.key))
                      .attr("x", 0)
                      .attr("y", function(d) { return faSalaryToY(d[0][1]) })
                      .attr("height", function(d) { return faSalaryToY(d[0][0]) - faSalaryToY(d[0][1])})
                      .attr("width", 30)

    freeAgentContainer.append("g")
                      .attr("transform", translate(-10, 0))
                      .attr("class", "capLine")
                      .append("line") 
                      .attr("x1", 0)
                      .attr("y1", d => faSalaryToY(projectedCap))
                      .attr("x2", 50)
                      .attr("y2", d => faSalaryToY(projectedCap))

    var label = d3.select("#sliders").append("ul").selectAll("input").data(team.freeAgents).enter()
                                .append("li")
                                .append("label")
                                    .attr('for', d => toId(d.name))
                                    .text(d => d.name)

        label.append("input")
             .attr("type", "text")
             .attr("class", "inputValue")
             .attr("id", d => toId(d.name))
             .attr("value", d => parseInt(d.salary))
             .on("change", function() {
                var playerName = this.parentElement.textContent;
                var newValue = parseInt(this.value);

                // change the value of the slider input
                var input = $('.inputSlider#' + toId(playerName))[0];
                input.value = newValue;    
             })

        label.append("input")
              .attr("type", "range")
              .attr("min", 0)
              .attr("max", 30000000)
              .attr("class", "inputSlider")
              .attr("value", d => d['salary'])
              .attr("id", d => toId(d['name']))
              .on("change", function() {
                  var playerName = this.parentElement.textContent;
                  var newValue = parseInt(this.value);
                  updateFreeAgentData(playerName, newValue);

                  // change the value of the text input
                  var input = $('.inputValue#' + toId(playerName))[0];
                  input.value = newValue;                  
              })

      function updateFreeAgentData(playerName, newValue) {
        for (var i = 0; i < team.freeAgents.length; i++){
            var elem = team.freeAgents[i];
            if (elem.name == playerName) {
                console.log('here');
                elem.salary = newValue;
            }
        }

        faSvg.select('.teamSalaryBar').remove();
        d3.select('#sliders ul').remove();
        faSvg.select('.yAxis').remove();
        drawFreeAgents(team); 
      }
  }

</script>
